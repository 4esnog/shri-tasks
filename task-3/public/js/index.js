"use strict";function onMagicButtonClick(e){e.preventDefault(),togglePreloader(!0),createVideo("http://cors.io/?u="+videoInput.value).then(function(e){canvas.width=videoWidth,canvas.height=videoHeight,backCanvas.width=videoWidth,backCanvas.height=videoHeight,ctx.fillStyle=canvasBgColor,ctx.fillRect(0,0,canvas.width,canvas.height),player.appendChild(ui.block),player.appendChild(canvas),video=e,document.querySelector("#popup").remove(),togglePreloader(!1)}),createAudio("http://cors.io/?u="+audioInput.value).then(function(e){audio=e}),fetch(subtitlesInput.value,"GET").then(function(e){subtitles=parseSrt(e)})}function onPlayPause(e){video.paused||video.ended?(state.paused=!1,video.play(),audio.play(),ui.play.classList.remove("paused")):(state.paused=!0,video.pause(),audio.pause(),ui.play.classList.add("paused"))}function onInputChange(e,t){var i=new FileReader;"subtitles"===e?(i.readAsText(t.target.files[0]),state.mediaLoad++,i.onloadend=function(e){subtitles=parseSrt(i.result),state.mediaLoad++}):"audio"===e?(i.readAsDataURL(t.target.files[0]),state.mediaLoad++,i.onloadend=function(e){audio=createAudio(i.result),state.mediaLoad++}):"video"===e&&(i.readAsDataURL(t.target.files[0]),state.mediaLoad++,i.onloadend=function(e){video=createVideo(i.result),state.mediaLoad++})}function createAudio(e){return new Promise(function(t,i){try{!function(){var i=document.createElement("audio");i.setAttribute("crossorigin","anonymus"),i.src=e,i.autoplay=!1,i.volume=.5,i.addEventListener("loadeddata",function(e){t(i);var n=new(window.AudioContext||window.webkitAudioContext),a=n.createMediaElementSource(i),o=n.createStereoPanner(),d=n.createStereoPanner();o.pan.value=-1,a.connect(d),a.connect(o),o.connect(n.destination)})}()}catch(n){i(n)}})}function createVideo(e){return new Promise(function(t,i){var n=document.createElement("video");n.setAttribute("crossorigin","anonymus"),n.setAttribute("preload","true"),n.src=e,n.autoplay=!1,n.controls=!1,n.defaultMuted=!0,n.style.visibility="hidden",n.addEventListener("play",onVideoPlay,!1),n.addEventListener("loadeddata",function(e){document.querySelector("body").appendChild(n),videoSizeRatio=n.clientWidth/n.clientHeight,videoWidth=parseInt(getComputedStyle(player).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,n.style.display="none",videoTimelineRatio=n.duration/100,subtitleStyles.padding=videoWidth*subtitleStyles.paddingRatio,subtitleStyles.fontSize=videoHeight*subtitleStyles.fontRatio,subtitleStyles.lineInterval=subtitleStyles.fontSize*subtitleStyles.lineIntervalRatio,t(n)}),n.addEventListener("timeupdate",function(e){var t=(1e3*e.target.currentTime).toFixed();t>=subtitles[state.subtitleIndex].endTime&&(state.subtitleShown=!0,n.pause(),state.subtitleTimer=setTimeout(hideSubtitle,subtitles[state.subtitleIndex].timeLength))})})}function createUI(){var e={block:document.createElement("div"),play:document.createElement("div"),stop:document.createElement("div"),timeline:document.createElement("input"),volume:document.createElement("input")};return e.block.classList.add("player-ui"),e.block.appendChild(e.play),e.block.appendChild(e.stop),e.block.appendChild(e.timeline),e.block.appendChild(e.volume),e.play.classList.add("player-ui__el","player-ui__el_play-pause","paused"),e.stop.classList.add("player-ui__el","player-ui__el_stop"),e.timeline.setAttribute("type","range"),e.timeline.classList.add("player-ui__el","player-ui__el_timeline"),e.timeline.value=0,e.volume.setAttribute("type","range"),e.volume.setAttribute("touch-action","none"),e.volume.classList.add("player-ui__el","player-ui__el_volume"),e.play.addEventListener("click",onPlayPause),e.stop.addEventListener("click",function(t){video.pause(),audio.pause(),video.currentTime=0,audio.currentTime=0,state.subtitleIndex=0,e.play.classList.add("paused"),e.timeline.value=0}),e.timeline.addEventListener("change",function(e){video.currentTime=parseInt(e.target.value)*videoTimelineRatio,audio.currentTime=video.currentTime}),e.volume.addEventListener("pointerdown",function(e){e.target.addEventListener("pointermove",onVolumeChange),e.target.addEventListener("pointerup",onVolumeChangeEnd)}),e.volume.addEventListener("click",function(e){audio.volume=e.target.value/100,0===audio.volume?e.target.classList.add("muted"):e.target.classList.remove("muted")}),e}function onVideoPlay(e){drawVideo(video,canvas,backCanvas,videoWidth,videoHeight),audio.play()}function onVolumeChange(e){audio.volume=parseInt(e.target.value)/100,0===audio.volume?e.target.classList.add("muted"):e.target.classList.remove("muted")}function onVolumeChangeEnd(e){e.target.removeEventListener("pointermove",onVolumeChange),e.target.removeEventListener("pointerup",onVolumeChangeEnd)}function drawVideo(e,t,i,n,a){var o=this;if(state.paused||e.ended||state.stopped)return audio.pause(),!1;var d=t.getContext("2d"),s=i.getContext("2d");t.getContext("webgl");if(!e.paused&&!state.subtitleShown){s.clearRect(0,0,n,a),d.clearRect(0,0,n,a),s.drawImage(e,0,0,n,a);for(var r=s.getImageData(0,0,n,a),l=r.data,u=getRandomInt(100-100*brightnessDiffRatio,100+100*brightnessDiffRatio)/100,c=0;c<l.length;c+=4){var v=getRandomInt(100-100*grainDiffRatio,100+100*grainDiffRatio)/100,m=l[c],p=l[c+1],g=l[c+2],h=(.21*m+.72*p+.07*g)*u*v;l[c]=h+15*v,l[c+1]=h+10*v,l[c+2]=h}d.putImageData(r,0,0)}state.subtitleShown&&showSubtitle(subtitles[state.subtitleIndex]),Math.random()<scratchStyle.frequency&&requestAnimationFrame(function(){drawScratches(t)});var y=1e3/getRandomInt(minFps,maxFps);setTimeout(function(){requestAnimationFrame(drawVideo.bind(o,e,t,i,videoWidth,videoHeight))},y)}function drawScratches(e){for(var t=e.getContext("2d"),i=(e.width,e.height,Math.floor(getRandomInt(0,100)-90)),n=0;n<=i;n++){var a=generateSingleScratch(e);t.strokeStyle=a.style,t.lineWidth=a.width,t.beginPath(),t.moveTo(a.coords.from.x,a.coords.from.y),t.lineTo(a.coords.to.x,a.coords.to.y),t.stroke(),t.closePath()}}function generateSingleScratch(e){var t=(e.getContext("2d"),e.width),i=e.height,n=getRandomInt(scratchStyle.minOpacity,scratchStyle.maxOpacity)/100,a=getRandomInt(140,180),o={r:getRandomInt(-20,20),g:getRandomInt(-20,20),b:getRandomInt(-20,20)},d={r:a+o.r,g:a+o.g,b:a+o.b,a:n},s="rgba("+d.r+", "+d.g+", "+d.b+", "+d.a+")",r=getRandomInt(1,2),l=2*Math.round(Math.random())-1,u=2*Math.round(Math.random())-1,c=getRandomInt(i*scratchStyle.minLength/100,i*scratchStyle.maxLength/100),v=getRandomInt(0,c),m=Math.sqrt(Math.pow(c,2)-Math.pow(v,2)),p={x:getRandomInt(0,t),y:getRandomInt(0,i)},g={x:p.x+v*l,y:p.y+m*u},h={from:p,to:g};return{style:s,width:r,coords:h}}function showSubtitle(e){if(!state.subtitleShown)return!1;var t=getRandomInt(100-100*brightnessDiffRatio,100+100*brightnessDiffRatio)/100,i={r:(canvasBgColor.r*t).toFixed(),g:(canvasBgColor.g*t).toFixed(),b:(canvasBgColor.b*t).toFixed()};ctx.fillStyle="rgb("+i.r+", "+i.g+", "+i.b+")",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle=canvasTextColor,ctx.font=subtitleStyles.fontSize+"px Oranienbaum bold, serif";var n=e.content.length*subtitleStyles.fontSize+(e.content.length-1)*subtitleStyles.lineInterval,a=(videoHeight-n)/2;e.content.forEach(function(e,t){var i=a+subtitleStyles.fontSize*t+subtitleStyles.lineInterval*t,n=subtitleStyles.padding;ctx.fillText(e,n,i)})}function hideSubtitle(){state.subtitleShown=!1,state.subtitleIndex++,video.play()}function parseSrt(e){var t={sec:1e3,min:60,hr:60},i=e.split("\n\n"),n=i.map(function(e){var i={},n=e.split("\n");i.number=parseInt(n[0]);var a=n[1].split(" --> "),o=a[0].split(":"),d=parseInt(o[2].split(",").join("")),s=parseInt(o[1])*t.min*t.sec,r=parseInt(o[0])*t.hr*t.min*t.sec;o=d+s+r,i.startTime=o;var l=a[1].split(":"),u=parseInt(l[2].split(",").join("")),c=parseInt(l[1])*t.min*t.sec,v=parseInt(l[0])*t.hr*t.min*t.sec;return l=u+c+v,i.endTime=l,i.timeLength=l-o,n.splice(0,2),i.content=n,i});return n}function onWindowResize(e){videoWidth=parseInt(getComputedStyle(player).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,canvas.width=videoWidth,canvas.height=videoHeight,backCanvas.width=videoWidth,backCanvas.height=videoHeight,subtitleStyles.padding=videoWidth*subtitleStyles.paddingRatio,subtitleStyles.fontSize=videoHeight*subtitleStyles.fontRatio,subtitleStyles.lineInterval=subtitleStyles.fontSize*subtitleStyles.lineIntervalRatio}function togglePreloader(e){var t=document.querySelectorAll(".preloader")[0];e===!0?t.classList.add("shown"):e===!1?t.classList.remove("shown"):t.classList.toggle("shown")}function fetch(e,t){return t=t||"GET",new Promise(function(i,n){var a=new XMLHttpRequest;a.open(t,e,!0),a.responseType="text",a.onreadystatechange=function(e){4===a.readyState&&(200!==a.status?n(a.responseText):i(a.responseText))},a.send()})}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e))+e}var urls={video:"https://cache-default04g.cdn.yandex.net/kp.cdn.yandex.net/502838/kinopoisk.ru-Sherlock-284167.mp4",videoLocal:"../assets/kinopoisk.ru-Sherlock-284167.mp4",audio:"https://upload.wikimedia.org/wikipedia/commons/2/2c/The_Entertainer_-_1902_-_By_Scott_Joplin.ogg",audioLocal:"../assets/The_Entertainer_-_1902_-_By_Scott_Joplin.ogg",srt:"https://raw.githubusercontent.com/shri-msk-2016/dz-multimedia/master/subs.srt",srtLocal:"../assets/subs.srt"},magicButton=document.getElementById("magic-button"),videoInput=document.getElementById("video"),audioInput=document.getElementById("audio"),subtitlesInput=document.getElementById("subtitles"),player=document.getElementById("player"),ui=createUI(),backCanvas=document.createElement("canvas"),canvas=document.createElement("canvas");backCanvas.setAttribute("crossorigin","anonymus"),canvas.setAttribute("crossorigin","anonymus");var ctx=canvas.getContext("2d"),bodyStyle=getComputedStyle(document.querySelectorAll("body")[0]),bodyPadding=parseInt(bodyStyle.paddingLeft)+parseInt(bodyStyle.paddingRight),canvasBgColor={r:16,g:20,b:16,hex:"#101410"},canvasTextColor="#e1e8e2",brightnessDiffRatio=.2,grainDiffRatio=.15,minFps=18,maxFps=26,scratchStyle={minLength:5,maxLength:20,minOpacity:30,maxOpacity:90,frequency:.75},subtitleStyles={fontRatio:.055,paddingRatio:.1,lineIntervalRatio:.5},state={subtitleShown:!1,subtitleIndex:0,mediaLoad:0,paused:!0},videoWidth=void 0,videoHeight=void 0,videoSizeRatio=void 0,videoTimelineRatio=void 0,video=void 0,audio=void 0,subtitles=void 0;magicButton.addEventListener("click",onMagicButtonClick),videoInput.addEventListener("change",onInputChange.bind(void 0,"video")),audioInput.addEventListener("change",onInputChange.bind(void 0,"audio")),subtitlesInput.addEventListener("change",onInputChange.bind(void 0,"subtitles")),canvas.addEventListener("click",onPlayPause),window.addEventListener("resize",onWindowResize);
//# sourceMappingURL=index.js.map
