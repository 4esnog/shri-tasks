"use strict";function onMagicButtonClick(t){t.preventDefault(),togglePreloader(!0),createVideo("http://cors.io/?u="+videoInput.value).then(function(t){canvas.width=videoWidth,canvas.height=videoHeight,backCanvas.width=videoWidth,backCanvas.height=videoHeight,ctx.fillStyle=canvasBgColor,ctx.fillRect(0,0,canvas.width,canvas.height),player.appendChild(ui.block),player.appendChild(canvas),video=t,document.querySelector("#popup").remove(),togglePreloader(!1)}),createAudio("http://cors.io/?u="+audioInput.value).then(function(t){audio=t}),fetch(subtitlesInput.value,"GET").then(function(t){subtitles=parseSrt(t)})}function onPlayPause(t){state.paused||video.ended?(state.paused=!1,state.stopped=!1,audio.play(),state.subtitleShown?(drawVideo(video,canvas,backCanvas,videoWidth,videoHeight),state.subtitleTimer=setTimeout(hideSubtitle,subtitles[state.subtitleIndex].timeLength),console.dir("Resume subtitles")):(video.play(),console.dir("Resume without subtitles")),audioApi.mainGainNode.connect(audioApi.ctx.destination),ui.play.classList.remove("paused")):(state.paused=!0,state.subtitleShown&&(clearInterval(state.subtitleTimer),state.subtitleEndTime=performance.now(),state.subtitleShownTime=(state.subtitleEndTime-state.subtitleStartTime).toFixed(),state.subtitleRestTime=subtitles[state.subtitleIndex].timeLength-state.subtitleShownTime),video.pause(),audio.pause(),audioApi.mainGainNode.disconnect(),ui.play.classList.add("paused"))}function onStop(t){state.stopped=!0,clearTimeout(state.subtitleTimer),video.pause(),audio.pause(),audioApi.mainGainNode.disconnect(),video.currentTime=0,audio.currentTime=0,state.subtitleIndex=0,ui.play.classList.add("paused")}function createAudio(t){return new Promise(function(e,i){try{!function(){var i=document.createElement("audio");i.setAttribute("crossorigin","anonymus"),i.src=t,i.autoplay=!1,i.addEventListener("loadeddata",function(t){audioApi.ctx=new(window.AudioContext||window.webkitAudioContext),audioApi.source=audioApi.ctx.createMediaElementSource(i),audioApi.mainGainNode=audioApi.ctx.createGain(),audioApi.mainGainNode.gain.value=.5,audioApi.pinkNoise=audioApi.ctx.createScriptProcessor(audioBufferSize/2,1,1),audioApi.pinkNoise.onaudioprocess=function(t){for(var e=0;e<t.outputBuffer.numberOfChannels;e++)for(var i=t.inputBuffer.getChannelData(e),a=t.outputBuffer.getChannelData(e),n=0;n<t.inputBuffer.length;n++){var o=2*Math.random()-1;a[n]=i[n]+.03*o}},audioApi.source.connect(audioApi.mainGainNode),audioApi.pinkNoise.connect(audioApi.mainGainNode),setInterval(function(){audioApi.mainGainNode.gain.value+=getRandomInt(-100*volumeSpreadRatio,100*volumeSpreadRatio)/1e3},200),e(i)})}()}catch(a){i(a)}})}function createVideo(t){return new Promise(function(e,i){try{!function(){var i=document.createElement("video");i.setAttribute("crossorigin","anonymus"),i.setAttribute("preload","true"),i.src=t,i.autoplay=!1,i.controls=!1,i.defaultMuted=!0,i.style.visibility="hidden",i.addEventListener("play",onVideoPlay,!1),i.addEventListener("loadeddata",function(t){document.querySelector("body").appendChild(i),videoSizeRatio=i.clientWidth/i.clientHeight,videoWidth=parseInt(getComputedStyle(player).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,videoTimelineRatio=i.duration/100,i.style.display="none",subtitleStyles.padding=videoWidth*subtitleStyles.paddingRatio,subtitleStyles.fontSize=videoHeight*subtitleStyles.fontRatio,subtitleStyles.lineInterval=subtitleStyles.fontSize*subtitleStyles.lineIntervalRatio,e(i)}),i.addEventListener("timeupdate",function(t){var e=(1e3*t.target.currentTime).toFixed();e>=subtitles[state.subtitleIndex].endTime&&!state.paused&&(state.subtitleShown=!0,state.subtitleStartTime=performance.now(),console.log("Start subtitles: ",state.subtitleStartTime),i.pause(),state.subtitleTimer=setTimeout(hideSubtitle,subtitles[state.subtitleIndex].timeLength))})}()}catch(a){i(a)}})}function createUI(){var t={block:document.createElement("div"),play:document.createElement("div"),stop:document.createElement("div"),volume:document.createElement("input")};return t.block.classList.add("player-ui"),t.block.appendChild(t.play),t.block.appendChild(t.stop),t.block.appendChild(t.volume),t.play.classList.add("player-ui__el","player-ui__el_play-pause","paused"),t.stop.classList.add("player-ui__el","player-ui__el_stop"),t.volume.setAttribute("type","range"),t.volume.setAttribute("touch-action","none"),t.volume.classList.add("player-ui__el","player-ui__el_volume"),t.play.addEventListener("click",onPlayPause),t.stop.addEventListener("click",onStop),t.volume.addEventListener("pointerdown",function(t){t.target.addEventListener("pointermove",onVolumeChange),t.target.addEventListener("pointerup",onVolumeChangeEnd)}),t.volume.addEventListener("click",function(t){audio.volume=t.target.value/100,0===audio.volume?t.target.classList.add("muted"):t.target.classList.remove("muted")}),t}function onVideoPlay(t){drawVideo(video,canvas,backCanvas,videoWidth,videoHeight)}function onVolumeChange(t){audioApi.mainGainNode.gain.value=parseInt(t.target.value)/100,0===audio.volume?t.target.classList.add("muted"):t.target.classList.remove("muted")}function onVolumeChangeEnd(t){t.target.removeEventListener("pointermove",onVolumeChange),t.target.removeEventListener("pointerup",onVolumeChangeEnd)}function drawVideo(t,e,i,a,n){var o=this;if(state.paused||t.ended||state.stopped)return audio.pause(),!1;var s=e.getContext("2d"),d=i.getContext("2d");if(!t.paused&&!state.subtitleShown){d.clearRect(0,0,a,n),s.clearRect(0,0,a,n),d.drawImage(t,0,0,a,n);for(var u=d.getImageData(0,0,a,n),l=u.data,r=getRandomInt(100-100*brightnessDiffRatio,100+100*brightnessDiffRatio)/100,c=0;c<l.length;c+=4){var p=getRandomInt(100-100*grainDiffRatio,100+100*grainDiffRatio)/100,m=l[c],v=l[c+1],h=l[c+2],g=(.21*m+.72*v+.07*h)*r*p;l[c]=g+15*p,l[c+1]=g+10*p,l[c+2]=g}s.putImageData(u,0,0)}state.subtitleShown&&showSubtitle(subtitles[state.subtitleIndex]),Math.random()<scratchStyle.frequency&&requestAnimationFrame(function(){drawScratches(e)});var b=1e3/getRandomInt(minFps,maxFps);setTimeout(function(){requestAnimationFrame(drawVideo.bind(o,t,e,i,videoWidth,videoHeight))},b)}function drawScratches(t){for(var e=t.getContext("2d"),i=(t.width,t.height,Math.floor(getRandomInt(0,100)-90)),a=0;a<=i;a++){var n=generateSingleScratch(t);e.strokeStyle=n.style,e.lineWidth=n.width,e.beginPath(),e.moveTo(n.coords.from.x,n.coords.from.y),e.lineTo(n.coords.to.x,n.coords.to.y),e.stroke(),e.closePath()}}function generateSingleScratch(t){var e=(t.getContext("2d"),t.width),i=t.height,a=getRandomInt(scratchStyle.minOpacity,scratchStyle.maxOpacity)/100,n=getRandomInt(140,180),o={r:getRandomInt(-20,20),g:getRandomInt(-20,20),b:getRandomInt(-20,20)},s={r:n+o.r,g:n+o.g,b:n+o.b,a:a},d="rgba("+s.r+", "+s.g+", "+s.b+", "+s.a+")",u=getRandomInt(1,2),l=2*Math.round(Math.random())-1,r=2*Math.round(Math.random())-1,c=getRandomInt(i*scratchStyle.minLength/100,i*scratchStyle.maxLength/100),p=getRandomInt(0,c),m=Math.sqrt(Math.pow(c,2)-Math.pow(p,2)),v={x:getRandomInt(0,e),y:getRandomInt(0,i)},h={x:v.x+p*l,y:v.y+m*r},g={from:v,to:h};return{style:d,width:u,coords:g}}function showSubtitle(t){if(!state.subtitleShown)return!1;var e=getRandomInt(100-100*brightnessDiffRatio,100+100*brightnessDiffRatio)/100,i={r:(canvasBgColor.r*e).toFixed(),g:(canvasBgColor.g*e).toFixed(),b:(canvasBgColor.b*e).toFixed()};ctx.fillStyle="rgb("+i.r+", "+i.g+", "+i.b+")",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle=canvasTextColor,ctx.font=subtitleStyles.fontSize+"px Oranienbaum bold, serif";var a=t.content.length*subtitleStyles.fontSize+(t.content.length-1)*subtitleStyles.lineInterval,n=(videoHeight-a)/2;t.content.forEach(function(t,e){var i=n+subtitleStyles.fontSize*e+subtitleStyles.lineInterval*e,a=subtitleStyles.padding;ctx.fillText(t,a,i)})}function hideSubtitle(){state.subtitleStartTime=null,state.subtitleEndTime=null,state.subtitleShown=!1,state.subtitleIndex++,video.play()}function parseSrt(t){var e={sec:1e3,min:60,hr:60},i=t.split("\n\n"),a=i.map(function(t){var i={},a=t.split("\n");i.number=parseInt(a[0]);var n=a[1].split(" --> "),o=n[0].split(":"),s=parseInt(o[2].split(",").join("")),d=parseInt(o[1])*e.min*e.sec,u=parseInt(o[0])*e.hr*e.min*e.sec;o=s+d+u,i.startTime=o;var l=n[1].split(":"),r=parseInt(l[2].split(",").join("")),c=parseInt(l[1])*e.min*e.sec,p=parseInt(l[0])*e.hr*e.min*e.sec;return l=r+c+p,i.endTime=l,i.timeLength=l-o,a.splice(0,2),i.content=a,i});return a}function onWindowResize(t){videoWidth=parseInt(getComputedStyle(player).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,canvas.width=videoWidth,canvas.height=videoHeight,backCanvas.width=videoWidth,backCanvas.height=videoHeight,subtitleStyles.padding=videoWidth*subtitleStyles.paddingRatio,subtitleStyles.fontSize=videoHeight*subtitleStyles.fontRatio,subtitleStyles.lineInterval=subtitleStyles.fontSize*subtitleStyles.lineIntervalRatio}function togglePreloader(t){var e=document.querySelectorAll(".preloader")[0];t===!0?e.classList.add("shown"):t===!1?e.classList.remove("shown"):e.classList.toggle("shown")}function fetch(t,e){return e=e||"GET",new Promise(function(i,a){var n=new XMLHttpRequest;n.open(e,t,!0),n.responseType="text",n.onreadystatechange=function(t){4===n.readyState&&(200!==n.status?a(n.responseText):i(n.responseText))},n.send()})}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t))+t}var magicButton=document.getElementById("magic-button"),videoInput=document.getElementById("video"),audioInput=document.getElementById("audio"),subtitlesInput=document.getElementById("subtitles"),player=document.getElementById("player"),ui=createUI(),backCanvas=document.createElement("canvas"),canvas=document.createElement("canvas");backCanvas.setAttribute("crossorigin","anonymus"),canvas.setAttribute("crossorigin","anonymus");var ctx=canvas.getContext("2d"),bodyStyle=getComputedStyle(document.querySelectorAll("body")[0]),bodyPadding=parseInt(bodyStyle.paddingLeft)+parseInt(bodyStyle.paddingRight),canvasBgColor={r:16,g:20,b:16,hex:"#101410"},canvasTextColor="#e1e8e2",brightnessDiffRatio=.2,grainDiffRatio=.15,minFps=18,maxFps=26,scratchStyle={minLength:5,maxLength:20,minOpacity:30,maxOpacity:90,frequency:.75},subtitleStyles={fontRatio:.055,paddingRatio:.1,lineIntervalRatio:.5},volumeSpreadRatio=.15,audioBufferSize=512,state={paused:!0,subtitleShown:!1,subtitleIndex:0,subtitleTimer:0,mediaLoad:0},videoWidth=void 0,videoHeight=void 0,videoSizeRatio=void 0,videoTimelineRatio=void 0,video=void 0,audio=void 0,subtitles=void 0,noiseGainNode=void 0,audioApi={};magicButton.addEventListener("click",onMagicButtonClick),canvas.addEventListener("click",onPlayPause),window.addEventListener("resize",onWindowResize);
//# sourceMappingURL=index.js.map
