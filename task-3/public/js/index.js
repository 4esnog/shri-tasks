"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function onMagicButtonClick(e){e.preventDefault(),togglePreloader(!0),Promise.all([createVideo("http://cors.io/?u="+videoInput.value),createAudio("http://cors.io/?u="+audioInput.value),fetch(subtitlesInput.value,"GET")]).then(function(e){canvas.width=videoWidth,canvas.height=videoHeight,backCanvas.width=videoWidth,backCanvas.height=videoHeight,ctx.fillStyle=canvasBgColor,ctx.fillRect(0,0,canvas.width,canvas.height),ui.appendTo(player),player.appendChild(canvas),video=e[0],audio=e[1],subtitles=new Subtitles(e[2],subtitleStyles),subtitles.padding=videoWidth*subtitles.paddingRatio,subtitles.fontSize=(videoHeight*subtitles.fontRatio).toFixed(),subtitles.lineInterval=subtitles.fontSize*subtitles.lineIntervalRatio,document.querySelector("#popup").remove(),togglePreloader(!1)})["catch"](function(e){console.dir(e)})}function onPlayPause(e){state.paused||video.ended?(state.paused=!1,state.stopped=!1,audio.play(),scratches.play(),subtitles.shown?(drawVideo(video,canvas,backCanvas,videoWidth,videoHeight),subtitles.timer=setTimeout(function(){subtitles.hide()},subtitles.collection[subtitles.index].timeLength)):video.play(),audioApi.mainGainNode.connect(audioApi.ctx.destination),ui.play.classList.remove("paused")):(state.paused=!0,subtitles.shown&&(clearTimeout(subtitles.timer),subtitles.endTime=performance.now(),subtitles.shownTime=(subtitles.endTime-subtitles.startTime).toFixed(),subtitles.restTime=subtitles.collection[subtitles.index].timeLength-subtitles.shownTime),video.pause(),scratches.pause(),audio.pause(),audioApi.mainGainNode.disconnect(),ui.play.classList.add("paused"))}function onStop(e){state.stopped=!0,clearTimeout(subtitles.timer),video.pause(),scratches.pause(),audio.pause(),audioApi.mainGainNode.disconnect(),video.currentTime=0,audio.currentTime=0,subtitles.index=0,ui.play.classList.add("paused")}function createAudio(e){return new Promise(function(t,i){try{!function(){var i=document.createElement("audio");i.setAttribute("crossorigin","anonymus"),i.src=e,i.autoplay=!1,i.addEventListener("loadeddata",function(e){audioApi.ctx=new(window.AudioContext||window.webkitAudioContext),audioApi.source=audioApi.ctx.createMediaElementSource(i),audioApi.mainGainNode=audioApi.ctx.createGain(),audioApi.mainGainNode.gain.value=.5,audioApi.whiteNoise=audioApi.ctx.createScriptProcessor(audioBufferSize/2,1,1),audioApi.whiteNoise.onaudioprocess=function(e){for(var t=0;t<e.outputBuffer.numberOfChannels;t++)for(var i=e.inputBuffer.getChannelData(t),n=e.outputBuffer.getChannelData(t),a=0;a<e.inputBuffer.length;a++){var o=2*Math.random()-1;n[a]=i[a]+.08*o}},audioApi.source.connect(audioApi.mainGainNode),audioApi.whiteNoise.connect(audioApi.mainGainNode),setInterval(function(){audioApi.mainGainNode.gain.value+=getRandomInt(-100*volumeSpreadRatio,100*volumeSpreadRatio)/1e3},200),t(i)})}()}catch(n){i(n)}})}function createVideo(e){return new Promise(function(t,i){try{!function(){var i=document.createElement("video");i.setAttribute("crossorigin","anonymus"),i.setAttribute("preload","true"),i.src=e,i.autoplay=!1,i.controls=!1,i.defaultMuted=!0,i.style.visibility="hidden",i.addEventListener("play",onVideoPlay,!1),i.addEventListener("loadeddata",function(e){document.querySelector("body").appendChild(i),videoSizeRatio=i.clientWidth/i.clientHeight,videoWidth=parseInt(getComputedStyle(player).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,videoTimelineRatio=i.duration/100,i.style.display="none",t(i)}),i.addEventListener("timeupdate",function(e){var t=(1e3*e.target.currentTime).toFixed();t>=subtitles.collection[subtitles.index].endTime&&!state.paused&&!subtitles.shown&&(i.pause(),subtitles.shown=!0,subtitles.startTime=performance.now(),subtitles.timer=setTimeout(function(){subtitles.hide()},subtitles.collection[subtitles.index].timeLength))})}()}catch(n){i(n)}})}function onVideoPlay(e){drawVideo(video,canvas,backCanvas,videoWidth,videoHeight)}function onVolumeChange(e){audioApi.mainGainNode.gain.value=parseInt(e.target.value)/100,0===audio.volume?e.target.classList.add("muted"):e.target.classList.remove("muted")}function onVolumeChangeEnd(e){e.target.removeEventListener("pointermove",onVolumeChange),e.target.removeEventListener("pointerup",onVolumeChangeEnd)}function drawVideo(e,t,i,n,a){if(state.paused||e.ended||state.stopped)return audio.pause(),!1;var o=t.getContext("2d"),s=i.getContext("2d");if(!e.paused&&!subtitles.shown){s.clearRect(0,0,n,a),o.clearRect(0,0,n,a);var d=getRandomInt(100-100*brightnessDiffRatio,100+100*brightnessDiffRatio)/100,r={r:(210*d).toFixed(),g:(210*d).toFixed(),b:(200*d).toFixed()};s.fillStyle="rgb("+r.r+", "+r.g+", "+r.b+")",s.drawImage(e,0,0,n,a),s.globalCompositeOperation="color",s.fillRect(0,0,n,a),s.globalCompositeOperation="exclusion",s.drawImage(scratches,0,0,n,a),o.drawImage(i,0,0,n,a)}subtitles.shown&&subtitles.show(subtitles.collection[subtitles.index]),Math.random()<scratchStyle.frequency&&requestAnimationFrame(function(){drawScratches(t)});var l=1e3/getRandomInt(minFps,maxFps);setTimeout(function(){requestAnimationFrame(function(){drawVideo(e,t,i,videoWidth,videoHeight)})},l)}function drawScratches(e){for(var t=e.getContext("2d"),i=(e.width,e.height,Math.floor(getRandomInt(0,100)-90)),n=0;n<=i;n++){var a=generateSingleScratch(e);t.strokeStyle=a.style,t.lineWidth=a.width,t.beginPath(),t.moveTo(a.coords.from.x,a.coords.from.y),t.lineTo(a.coords.to.x,a.coords.to.y),t.stroke(),t.closePath()}}function generateSingleScratch(e){var t=(e.getContext("2d"),e.width),i=e.height,n=getRandomInt(scratchStyle.minOpacity,scratchStyle.maxOpacity)/100,a=getRandomInt(140,180),o={r:getRandomInt(-20,20),g:getRandomInt(-20,20),b:getRandomInt(-20,20)},s={r:a+o.r,g:a+o.g,b:a+o.b,a:n},d="rgba("+s.r+", "+s.g+", "+s.b+", "+s.a+")",r=getRandomInt(1,2),l=2*Math.round(Math.random())-1,u=2*Math.round(Math.random())-1,c=getRandomInt(i*scratchStyle.minLength/100,i*scratchStyle.maxLength/100),h=getRandomInt(0,c),p=Math.sqrt(Math.pow(c,2)-Math.pow(h,2)),m={x:getRandomInt(0,t),y:getRandomInt(0,i)},v={x:m.x+h*l,y:m.y+p*u},g={from:m,to:v};return{style:d,width:r,coords:g}}function onWindowResize(e){videoWidth=parseInt(getComputedStyle(player).width).toFixed(),videoHeight=videoWidth/videoSizeRatio,canvas.width=videoWidth,canvas.height=videoHeight,backCanvas.width=videoWidth,backCanvas.height=videoHeight,subtitles.padding=videoWidth*subtitles.paddingRatio,subtitles.fontSize=(videoHeight*subtitles.fontRatio).toFixed(),subtitles.lineInterval=subtitles.fontSize*subtitles.lineIntervalRatio}function togglePreloader(e){var t=document.querySelectorAll(".preloader")[0];e===!0?t.classList.add("shown"):e===!1?t.classList.remove("shown"):t.classList.toggle("shown")}function fetch(e,t){return t=t||"GET",new Promise(function(i,n){var a=new XMLHttpRequest;a.open(t,e,!0),a.responseType="text",a.onreadystatechange=function(e){4===a.readyState&&(200!==a.status?n(a.responseText):i(a.responseText))},a.send()})}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e))+e}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),UI=function(){function e(){_classCallCheck(this,e),this.block=document.createElement("div"),this.play=document.createElement("div"),this.stop=document.createElement("div"),this.volume=document.createElement("input"),this.block.classList.add("player-ui"),this.block.appendChild(this.play),this.block.appendChild(this.stop),this.block.appendChild(this.volume),this.play.classList.add("player-ui__el","player-ui__el_play-pause","paused"),this.stop.classList.add("player-ui__el","player-ui__el_stop"),this.volume.setAttribute("type","range"),this.volume.setAttribute("touch-action","none"),this.volume.classList.add("player-ui__el","player-ui__el_volume"),this.play.addEventListener("click",onPlayPause),this.stop.addEventListener("click",onStop),this.volume.addEventListener("pointerdown",function(e){e.target.addEventListener("pointermove",onVolumeChange),e.target.addEventListener("pointerup",onVolumeChangeEnd)}),this.volume.addEventListener("click",function(e){audio.volume=e.target.value/100,0===audio.volume?e.target.classList.add("muted"):e.target.classList.remove("muted")})}return _createClass(e,[{key:"appendTo",value:function(e){e.appendChild(this.block)}}]),e}(),Subtitles=function(){function e(t,i){_classCallCheck(this,e),this.collection=e.parseSrt(t),this.startTime=null,this.endTime=null,this.shown=!1,this.index=0,this.timer=0,this.fontRatio=i.fontRatio,this.paddingRatio=i.paddingRatio,this.lineIntervalRatio=i.lineIntervalRatio}return _createClass(e,[{key:"show",value:function(e){var t=this;if(!this.shown)return!1;var i=getRandomInt(100-100*brightnessDiffRatio,100+100*brightnessDiffRatio)/100,n={r:(canvasBgColor.r*i).toFixed(),g:(canvasBgColor.g*i).toFixed(),b:(canvasBgColor.b*i).toFixed()};ctx.fillStyle="rgb("+n.r+", "+n.g+", "+n.b+")",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle=canvasTextColor,ctx.font=this.fontSize+"px 'Oranienbaum'";var a=e.content.length*this.fontSize+(e.content.length-1)*this.lineInterval,o=(videoHeight-a)/2;e.content.forEach(function(e,i){var n=o+t.fontSize*i+t.lineInterval*i,a=t.padding;ctx.fillText(e,a,n)})}},{key:"hide",value:function(){this.startTime=null,this.endTime=null,this.shown=!1,this.index++,video.play()}}],[{key:"parseSrt",value:function(e){var t={sec:1e3,min:60,hr:60},i=e.split("\n\n"),n=i.map(function(e){var i={},n=e.split("\n");i.number=parseInt(n[0]);var a=n[1].split(" --> "),o=a[0].split(":"),s=parseInt(o[2].split(",").join("")),d=parseInt(o[1])*t.min*t.sec,r=parseInt(o[0])*t.hr*t.min*t.sec;o=s+d+r,i.startTime=o;var l=a[1].split(":"),u=parseInt(l[2].split(",").join("")),c=parseInt(l[1])*t.min*t.sec,h=parseInt(l[0])*t.hr*t.min*t.sec;return l=u+c+h,i.endTime=l,i.timeLength=l-o,n.splice(0,2),i.content=n,i});return n}}]),e}(),magicButton=document.getElementById("magic-button"),videoInput=document.getElementById("video"),audioInput=document.getElementById("audio"),subtitlesInput=document.getElementById("subtitles"),player=document.getElementById("player"),scratches=document.getElementById("scratches"),backCanvas=document.createElement("canvas"),canvas=document.createElement("canvas");backCanvas.setAttribute("crossorigin","anonymus"),canvas.setAttribute("crossorigin","anonymus");var ctx=canvas.getContext("2d"),ui=new UI,bodyStyle=getComputedStyle(document.querySelectorAll("body")[0]),bodyPadding=parseInt(bodyStyle.paddingLeft)+parseInt(bodyStyle.paddingRight),canvasBgColor={r:16,g:20,b:16,hex:"#101410"},canvasTextColor="#e1e8e2",brightnessDiffRatio=.3,grainDiffRatio=.15,minFps=20,maxFps=40,scratchStyle={minLength:5,maxLength:20,minOpacity:30,maxOpacity:90,frequency:.75},subtitleStyles={fontRatio:.055,paddingRatio:.1,lineIntervalRatio:.5},volumeSpreadRatio=.15,audioBufferSize=512,state={paused:!0,mediaLoad:0},videoWidth=void 0,videoHeight=void 0,videoSizeRatio=void 0,videoTimelineRatio=void 0,video=void 0,audio=void 0,subtitles=void 0,noiseGainNode=void 0,audioApi={};magicButton.addEventListener("click",onMagicButtonClick),canvas.addEventListener("click",onPlayPause),window.addEventListener("resize",onWindowResize);
//# sourceMappingURL=index.js.map
