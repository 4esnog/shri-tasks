{"version":3,"sources":["js/index.js"],"names":["onMagicButtonClick","e","preventDefault","state","mediaLoad","alert","setTimeout","bind","this","document","querySelector","style","opacity","player","appendChild","canvas","width","videoWidth","height","videoHeight","backCanvas","ctx","fillStyle","canvasBgColor","fillRect","ui","block","remove","onPlayPause","video","paused","ended","play","audio","classList","pause","add","onInputChange","type","reader","FileReader","readAsText","target","files","onloadend","subtitles","parseSrt","result","readAsDataURL","createAudio","createVideo","src","createElement","autoplay","volume","controls","defaultMuted","visibility","addEventListener","onVideoPlay","videoSizeRatio","clientWidth","clientHeight","parseInt","getComputedStyle","toFixed","display","videoTimelineRatio","duration","subtitleStyles","padding","paddingRatio","fontSize","fontRatio","lineInterval","lineIntervalRatio","time","currentTime","subtitleIndex","endTime","subtitleShown","subtitleTimer","hideSubtitle","timeLength","createUI","stop","timeline","setAttribute","value","onVolumeChange","onVolumeChangeEnd","drawVideo","removeEventListener","stopped","getContext","bctx","clearRect","drawImage","imgData","getImageData","data","brightnessRatio","getRandomInt","brightnessDiffRatio","i","length","grainRatio","grainDiffRatio","r","g","b","avg","putImageData","showSubtitle","Math","random","scratchStyle","frequency","requestAnimationFrame","drawScratches","newFps","minFps","maxFps","amount","floor","scratch","generateSingleScratch","strokeStyle","lineWidth","beginPath","moveTo","coords","from","x","y","lineTo","to","stroke","closePath","minOpacity","maxOpacity","gray","modifiers","color","a","flagX","round","flagY","minLength","maxLength","maxX","maxY","sqrt","pow","startCoords","endCoords","subtl","console","log","cl","dir","canvasTextColor","font","fullTextHeight","content","topPadding","forEach","el","top","left","fillText","text","timeConst","sec","min","hr","temp","split","map","res","subtitle","number","startTime","startTimeSec","join","startTimeMin","startTimeHr","endTimeSec","endTimeMin","endTimeHr","splice","onWindowResize","max","download","mime","url","_this","xhr","XMLHttpRequest","open","withCredentials","responseTye","onload","status","Blob","response","send","urls","videoLocal","audioLocal","srt","srtLocal","magicButton","getElementById","videoInput","audioInput","subtitlesInput","bodyStyle","querySelectorAll","bodyPadding","paddingLeft","paddingRight","hex","undefined","window"],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\n\n// import srt from 'srt.js';\n\nconst urls = {\n\tvideo: 'https://cache-default04g.cdn.yandex.net/kp.cdn.yandex.net/502838/kinopoisk.ru-Sherlock-284167.mp4',\n\tvideoLocal: '../assets/kinopoisk.ru-Sherlock-284167.mp4',\n\n\taudio: 'https://upload.wikimedia.org/wikipedia/commons/2/2c/The_Entertainer_-_1902_-_By_Scott_Joplin.ogg',\n\taudioLocal: '../assets/The_Entertainer_-_1902_-_By_Scott_Joplin.ogg',\n\n\tsrt: 'https://raw.githubusercontent.com/shri-msk-2016/dz-multimedia/master/subs.srt',\n\tsrtLocal: '../assets/subs.srt'\n};\n\n// Get existing DOM nodes\nconst magicButton = document.getElementById('magic-button');\nconst videoInput = document.getElementById('video');\nconst audioInput = document.getElementById('audio');\nconst subtitlesInput = document.getElementById('subtitles');\nconst player = document.getElementById('player');\n\n// Init player UI\nconst ui = createUI();\n\n// Init canvas w/ styles\nconst backCanvas = document.createElement('canvas');\nconst canvas = document.createElement('canvas');\nconst\tctx = canvas.getContext('2d');\n\n\nlet bodyStyle = getComputedStyle(document.querySelectorAll('body')[0]);\nlet bodyPadding = parseInt(bodyStyle.paddingLeft) + parseInt(bodyStyle.paddingRight);\n\n// === НАСТРОЙКИ ===\n// Цвет фона субтитров\nconst canvasBgColor = {\n\tr: 16,\n\tg: 20,\n\tb: 16,\n\thex: \"#101410\"\n};\nconst canvasTextColor = '#e1e8e2'; // Цвет текста субтитров\nconst brightnessDiffRatio = 0.2; // Коэффициент разброса яркости кадров\nconst grainDiffRatio = 0.15; // Коэффициент зернистости (шума)\nconst minFps = 18;\nconst maxFps = 26;\nconst scratchStyle = {\n\tminLength: 5,    // Длина и прозрачность царапин,\n\tmaxLength: 20,   // в % от высоты видео (от 0 до 100)\n\tminOpacity: 30,  // 0 .. 100\n\tmaxOpacity: 90,  // 0 .. 100\n\tfrequency: 0.75, // 0 .. 1\n}\n// const downsampleRatio = 5;\nconst subtitleStyles = {\n\tfontRatio: 0.055,\n\tpaddingRatio: 0.1,\n\tlineIntervalRatio: 0.5\n};\n// === END НАСТРОЙКИ ===\n\n\nlet state = {\n\tsubtitleShown: false,\n\tsubtitleIndex: 0,\n\tmediaLoad: 0,\n\tpaused: true\n};\n\nlet\tvideoWidth,\n\t\tvideoHeight,\n\t\tvideoSizeRatio,\n\t\tvideoTimelineRatio,\n\t\tvideo,\n\t\taudio,\n\t\tsubtitles;\n\n\n// === Set initial event handlers ===\nmagicButton.addEventListener('click', onMagicButtonClick);\nvideoInput.addEventListener('change', onInputChange.bind(this, 'video'));\naudioInput.addEventListener('change', onInputChange.bind(this, 'audio'));\nsubtitlesInput.addEventListener('change', onInputChange.bind(this, 'subtitles'));\ncanvas.addEventListener('click', onPlayPause);\nwindow.addEventListener('resize', onWindowResize);\n\n\n// === Helpers ===\n\n// === Handle \"Maigc\" button click ===\nfunction onMagicButtonClick(e) {\n\te.preventDefault();\n\n\tif (state.mediaLoad < 5) {\n\t\talert('Вы что-то забыли :)');\n\t\treturn;\n\n\t} else if (state.mediaLoad < 6) {\n\t\tsetTimeout(onMagicButtonClick.bind(this, e), 400);\n\t\tdocument.querySelector('#popup .popup').style.opacity = '0.5';\n\t\treturn;\n\n\t}\n\tplayer.appendChild(canvas);\n\n\tcanvas.width = videoWidth;\n\tcanvas.height = videoHeight;\n\n\tbackCanvas.width = videoWidth;\n\tbackCanvas.height = videoHeight;\n\tctx.fillStyle = canvasBgColor;\n\tctx.fillRect(0, 0, canvas.width, canvas.height);\n\tplayer.appendChild(ui.block);\n\n\tdocument.querySelector('#popup').remove();\n}\n\nfunction onPlayPause(e) {\n\tif (video.paused || video.ended) {\n\t\tstate.paused = false;\n\t\tvideo.play();\n\t\taudio.play();\n\t\tui.play.classList.remove('paused');\n\t} else {\n\t\tstate.paused = true;\n\t\tvideo.pause();\n\t\taudio.pause();\n\t\tui.play.classList.add('paused');\n\t}\n}\n\n\n// === Process input ===\nfunction onInputChange(type, e) {\n\t\n\tlet reader = new FileReader();\n\n\tif (type === 'subtitles') {\n\t\treader.readAsText(e.target.files[0]);\n\t\tstate.mediaLoad++;\n\t\treader.onloadend = (e) => {\t\t\n\t\t\tsubtitles = parseSrt(reader.result);\n\t\t\tstate.mediaLoad++;\n\t\t}\n\n\t} else if (type === 'audio') {\n\t\treader.readAsDataURL(e.target.files[0]);\n\t\tstate.mediaLoad++;\n\t\treader.onloadend = (e) => {\t\t\n\t\t\taudio = createAudio(reader.result);\n\t\t\tstate.mediaLoad++;\n\t\t}\n\n\t} else if (type === 'video') {\n\t\treader.readAsDataURL(e.target.files[0]);\n\t\tstate.mediaLoad++;\n\t\treader.onloadend = (e) => {\t\t\n\t\t\tvideo = createVideo(reader.result);\n\t\t\tstate.mediaLoad++;\n\t\t}\n\n\t}\n\n}\n\n// === Process audio from input ===\nfunction createAudio(src) {\n\tlet audio = document.createElement('audio');\n\taudio.src = src;\n\taudio.autoplay = false;\n\taudio.volume = 0.5;\n\n\t// audio.addEventListener('canplay', (e) => {\n\t// \t// console.dir('Загружено');\n\t// \tlet audioCtx = new (window.AudioContext || window.webkitAudioContext)();\n\t// \tlet source = audioCtx.createMediaElementSource(audio);\n\t// \tlet leftPan = audioCtx.createStereoPanner();\n\t// \tleftPan.pan.value = -1;\n\t// \t// let rightPan = audioCtx.createStereoPanner();\n\t// \t// rightPan.pan.value = 1;\n\n\t// \tlet gainNode = audioCtx.createGain();\n\n\t\t\n\t// \tsource.connect(gainNode);\n\t// \t// source.connect(rightPan);\n\t// \t// leftPan.connect(gainNode);\n\t// \tgainNode.connect(audioCtx.destination);\n\n\t// \t// source.connect(audioCtx.destination);\n\t// });\n\t\n\n\treturn audio;\n}\n\n// === Process video from input ===\nfunction createVideo(src) {\n\tlet video = document.createElement('video');\n\tvideo.src = src;\n\tvideo.autoplay = false;\n\tvideo.controls = false;\n\tvideo.defaultMuted = true;\n\tvideo.style.visibility = 'hidden';\n\n\tvideo.addEventListener('play', onVideoPlay, false);\n\t\n\tvideo.addEventListener('loadeddata', (e) => {\n\t\tdocument.querySelector('body').appendChild(video);\n\t\t\t\t\n\t\t// videoWidth = video.clientWidth;\n\t\t// videoHeight = video.clientHeight;\n\t\tvideoSizeRatio = video.clientWidth / video.clientHeight;\n\t\tvideoWidth = parseInt(getComputedStyle(player).width).toFixed();\n\t\tvideoHeight = videoWidth / videoSizeRatio;\n\t\t\n\t\tvideo.style.display = 'none';\n\t\tvideoTimelineRatio = video.duration / 100;\n\n\t\tsubtitleStyles.padding = videoWidth * subtitleStyles.paddingRatio;\n\t\tsubtitleStyles.fontSize = videoHeight * subtitleStyles.fontRatio;\n\t\tsubtitleStyles.lineInterval = subtitleStyles.fontSize * subtitleStyles.lineIntervalRatio;\n\t\t\n\t});\n\n\tvideo.addEventListener('timeupdate', (e) => {\n\t\tlet time = (e.target.currentTime * 1000).toFixed();\n\t\tif (time >= subtitles[state.subtitleIndex].endTime) {\n\t\t\tstate.subtitleShown = true;\n\t\t\tvideo.pause();\n\t\t\tstate.subtitleTimer = setTimeout(hideSubtitle, subtitles[state.subtitleIndex].timeLength);\n\t\t}\n\t\t\n\t});\n\n\treturn video;\n}\n\n// === Init UI for canvas player\nfunction createUI() {\n\tlet ui = {\n\t\tblock: document.createElement('div'),\n\t\tplay: document.createElement('div'),\n\t\tstop: document.createElement('div'),\n\t\ttimeline: document.createElement('input'),\n\t\tvolume: document.createElement('input')\n\t};\n\tui.block.classList.add('player-ui');\n\tui.block.appendChild(ui.play);\n\tui.block.appendChild(ui.stop);\n\tui.block.appendChild(ui.timeline);\n\tui.block.appendChild(ui.volume);\n\n\tui.play.classList.add('player-ui__el', 'player-ui__el_play-pause', 'paused');\n\tui.stop.classList.add('player-ui__el', 'player-ui__el_stop');\n\tui.timeline.setAttribute('type', 'range');\n\tui.timeline.classList.add('player-ui__el', 'player-ui__el_timeline');\n\tui.timeline.value = 0;\n\tui.volume.setAttribute('type', 'range');\n\tui.volume.setAttribute('touch-action', 'none');\n\tui.volume.classList.add('player-ui__el', 'player-ui__el_volume');\n\n\tui.play.addEventListener('click', onPlayPause);\n\n\tui.stop.addEventListener('click', (e) => {\n\t\tvideo.pause();\n\t\t// scratches.pause();\n\t\taudio.pause();\n\t\tvideo.currentTime = 0;\n\t\taudio.currentTime = 0;\n\t\tstate.subtitleIndex = 0;\n\t\tui.play.classList.add('paused');\n\t\tui.timeline.value = 0;\n\t});\n\n\tui.timeline.addEventListener('change', (e) => {\n\t\tvideo.currentTime = parseInt(e.target.value) * videoTimelineRatio;\n\t\taudio.currentTime = video.currentTime;\n\t});\n\n\tui.volume.addEventListener('pointerdown', (e) => {\n\t\te.target.addEventListener('pointermove', onVolumeChange);\n\t\te.target.addEventListener('pointerup', onVolumeChangeEnd);\n\t});\n\n\tui.volume.addEventListener('click', (e) => {\n\t\taudio.volume = e.target.value / 100;\n\t\tif (audio.volume === 0) {\n\t\t\te.target.classList.add('muted');\n\t\t} else {\n\t\t\te.target.classList.remove('muted');\n\t\t}\n\t});\n\n\treturn ui;\n}\n\n// === Process video.play() ===\nfunction onVideoPlay(e) {\n\tdrawVideo(video, canvas, backCanvas, videoWidth, videoHeight);\n\taudio.play();\n}\n\nfunction onVolumeChange(e) {\n\taudio.volume = parseInt(e.target.value) / 100;\n\tif (audio.volume === 0) {\n\t\te.target.classList.add('muted');\n\t} else {\n\t\te.target.classList.remove('muted');\n\t}\n}\n\nfunction onVolumeChangeEnd(e) {\n\te.target.removeEventListener('pointermove', onVolumeChange);\n\te.target.removeEventListener('pointerup', onVolumeChangeEnd);\n}\n\n// === Draw video on canvas with Effects ===\nfunction drawVideo(video, canvas, backCanvas, width, height) {\n\t\n\tif (state.paused || video.ended || state.stopped) {\n\t\treturn false;\n\t}\n\n\tconst ctx = canvas.getContext('2d');\n\tconst bctx = backCanvas.getContext('2d');\n\n\t// requestAnimationFrame(() => {\n\n\t\tif (!video.paused && !state.subtitleShown) {\n\t\t\tbctx.clearRect(0, 0, width, height);\n\t\t\tctx.clearRect(0, 0, width, height);\n\t\t\t\n\t\t\tbctx.drawImage(video, 0, 0, width, height);\n\t\t\tlet imgData = bctx.getImageData(0, 0, width, height);\n\t\t\tlet data = imgData.data;\n\t\t\tlet brightnessRatio = getRandomInt(\n\t\t\t\t100 - 100*brightnessDiffRatio,\n\t\t\t\t100 + 100*brightnessDiffRatio) / 100;\n\n\t\t\tfor (let i = 0; i < data.length; i+=4) {\n\t\t\t\tlet grainRatio = getRandomInt(\n\t\t\t\t\t100 - 100*grainDiffRatio,\n\t\t\t\t\t100 + 100*grainDiffRatio) / 100;\n\n\t\t\t\tlet r = data[i];\n\t\t\t\tlet g = data[i+1];\n\t\t\t\tlet b = data[i+2];\n\n\t\t\t\tlet avg = ((0.21 * r) + (0.72 * g) + (0.07 * b)) * brightnessRatio * grainRatio;\n\n\t\t\t\tdata[i] = avg + 15 * grainRatio;\n\t\t\t\tdata[i+1] = avg + 10 * grainRatio;\n\t\t\t\tdata[i+2] = avg;\n\t\t\t}\n\n\t\t\tctx.putImageData(imgData, 0, 0);\n\t\t}\n\t\t\n\t\tif (state.subtitleShown) {\n\t\t\tshowSubtitle(subtitles[state.subtitleIndex]);\n\t\t}\n\n\t// });\n\n\tif (Math.random() < scratchStyle.frequency) {\n\t\trequestAnimationFrame(() => {\n\t\t\tdrawScratches(canvas);\n\t\t});\t\n\t}\n\t\n\tlet newFps = 1000 / getRandomInt(minFps, maxFps); // 1000 - ms in s\n\n\tsetTimeout(drawVideo, newFps, video, canvas, backCanvas, videoWidth, videoHeight);\n}\n\nfunction drawScratches(canvas) {\n\tconst ctx = canvas.getContext('2d');\n\tconst width = canvas.width;\n\tconst height = canvas.height;\n\n\tconst amount = Math.floor(getRandomInt(0, 100) - 90); // MAGIC 2\n\n\tfor (let i = 0; i <= amount; i++) {\n\t\tlet scratch = generateSingleScratch(canvas);\n\t\tctx.strokeStyle = scratch.style;\n\t\tctx.lineWidth = scratch.width;\n\n\t\tctx.beginPath();\n\t\tctx.moveTo(scratch.coords.from.x, scratch.coords.from.y);\n\t\tctx.lineTo(scratch.coords.to.x, scratch.coords.to.y);\n\t\tctx.stroke();\n\t\tctx.closePath();\n\t}\n}\n\nfunction generateSingleScratch(canvas) {\n\tconst ctx = canvas.getContext('2d');\n\tconst width = canvas.width;\n\tconst height = canvas.height;\n\n\t// === Generate strokeStyle ===\n\tlet opacity = getRandomInt(scratchStyle.minOpacity, scratchStyle.maxOpacity) / 100; // MAGIC\n\tlet gray = getRandomInt(140, 180); // MAGIC\n\tlet modifiers = {\n\t\tr: getRandomInt(-20, 20),\n\t\tg: getRandomInt(-20, 20),\n\t\tb: getRandomInt(-20, 20)\n\t};\n\tlet color = {\n\t\tr: gray + modifiers.r,\n\t\tg: gray + modifiers.g,\n\t\tb: gray + modifiers.b,\n\t\ta: opacity\n\t};\n\n\tlet strokeStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${color.a})`;\n\n\t// === Generate scratch width ===\n\tlet lineWidth = getRandomInt(1, 2);\n\t\n\t// === Generate scratch coords ===\n\t// flag = 0 или 2\n\tlet flagX = 2 * Math.round(Math.random());\n\tlet flagY = 2 * Math.round(Math.random());\n\n\tlet length = getRandomInt(height * scratchStyle.minLength / 100,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\theight * scratchStyle.maxLength / 100);\n\tlet maxX = getRandomInt(0, length);\n\tlet maxY = Math.sqrt(Math.pow(length, 2) - Math.pow(maxX, 2));\n\n\tlet startCoords = {\n\t\tx: getRandomInt(0, width),\n\t\ty: getRandomInt(0, height),\n\t};\n\n\tlet endCoords = {\n\t\tx: startCoords.x + maxX - maxX*flagX,\n\t\ty: startCoords.y + maxY - maxY*flagY,\n\t};\n\n\tlet coords = {\n\t\tfrom: startCoords,\n\t\tto: endCoords\n\t};\n\n\treturn {\n\t\tstyle: strokeStyle,\n\t\twidth: lineWidth,\n\t\tcoords: coords\n\t};\n\n}\n\n\nfunction showSubtitle(subtl) {\n\n\tif (!state.subtitleShown) {\n\t\tconsole.log('Don\\'t show :(');\n\t\treturn false;\n\t}\n\n// rgb(16, 17, 16)\n\tlet brightnessRatio = getRandomInt(\n\t\t100 - 100*brightnessDiffRatio,\n\t\t100 + 100*brightnessDiffRatio) / 100;\n\tlet cl = {\n\t\tr: (canvasBgColor.r * brightnessRatio).toFixed(),\n\t\tg: (canvasBgColor.g * brightnessRatio).toFixed(),\n\t\tb: (canvasBgColor.b * brightnessRatio).toFixed()\n\t};\n\tconsole.dir(cl);\n\tctx.fillStyle = `rgb(${cl.r}, ${cl.g}, ${cl.b})`;\n\tctx.fillRect(0, 0, canvas.width, canvas.height);\n\tctx.fillStyle = canvasTextColor;\n\tctx.font = `${subtitleStyles.fontSize}px Oranienbaum bold, serif`;\n\n\tlet fullTextHeight = (subtl.content.length * subtitleStyles.fontSize)\n\t\t\t\t\t\t\t + ((subtl.content.length - 1) * subtitleStyles.lineInterval);\n\tlet topPadding = (videoHeight - fullTextHeight) / 2;\n\n\tsubtl.content.forEach((el, i) => {\n\t\tlet top = topPadding + (subtitleStyles.fontSize * i)\n\t\t\t\t\t\t\t+ (subtitleStyles.lineInterval * i);\n\t\tlet left = subtitleStyles.padding;\n\t\tctx.fillText(el, left, top);\n\t});\n\t\n}\n\nfunction hideSubtitle() {\n\tstate.subtitleShown = false;\n\tstate.subtitleIndex++;\n\tvideo.play();\n}\n\n// === Parse .SRT to Array of subtitles ===\nfunction parseSrt(text) {\n\tlet timeConst = {\n\t\tsec: 1000,\n\t\tmin: 60,\n\t\thr: 60\n\t};\n\tlet temp = text.split('\\n\\n');\n\n\tlet result = temp.map((el) => {\n\n\t\tlet res = {};\n\t\tlet subtitle = el.split('\\n');\n\n\t\t// === Get subtitle's number ===\n\t\tres.number = parseInt(subtitle[0]);\n\n\t\tlet time = subtitle[1].split(' --> ');\n\n\t\t// === Convert start time to MS ===\n\t\tlet startTime = time[0].split(':');\n\t\tlet startTimeSec = parseInt(startTime[2].split(',').join(''));\n\t\tlet startTimeMin = parseInt(startTime[1]) * timeConst.min * timeConst.sec;\n\t\tlet startTimeHr = parseInt(startTime[0]) * timeConst.hr * timeConst.min * timeConst.sec;\n\t\tstartTime = startTimeSec + startTimeMin\t+ startTimeHr;\n\t\tres.startTime = startTime;\n\n\t\t// === Convert end time to MS ===\n\t\tlet endTime = time[1].split(':');\n\t\tlet endTimeSec = parseInt(endTime[2].split(',').join(''));\n\t\tlet endTimeMin = parseInt(endTime[1]) * timeConst.min * timeConst.sec;\n\t\tlet endTimeHr = parseInt(endTime[0]) * timeConst.hr * timeConst.min * timeConst.sec;\n\t\tendTime = endTimeSec + endTimeMin\t+ endTimeHr;\n\t\tres.endTime = endTime;\n\n\t\tres.timeLength = endTime - startTime;\n\n\t\t// res.content = subtitle.reduce((prev, el, i) => {\n\t\t// \tif (i > 1) {\n\t\t// \t\treturn prev + el + '\\n';\n\t\t// \t} else {\n\t\t// \t\treturn '';\n\t\t// \t}\n\t\t// });\n\n\t\t// === Join subtitle content ===\n\t\tsubtitle.splice(0, 2);\n\t\tres.content = subtitle;\n\n\t\treturn res;\n\t});\n\n\treturn result;\n\n}\n\nfunction onWindowResize(e) {\n\t\n\tvideoWidth = parseInt(getComputedStyle(player).width).toFixed();\n\tvideoHeight = videoWidth / videoSizeRatio;\n\n\tcanvas.width = videoWidth;\n\tcanvas.height = videoHeight;\n\tbackCanvas.width = videoWidth;\n\tbackCanvas.height = videoHeight;\n\n\tsubtitleStyles.padding = videoWidth * subtitleStyles.paddingRatio;\n\tsubtitleStyles.fontSize = videoHeight * subtitleStyles.fontRatio;\n\tsubtitleStyles.lineInterval = subtitleStyles.fontSize * subtitleStyles.lineIntervalRatio;\n\t// if (state.subtitleShown) {\n\t// \tshowSubtitle(subtitles[state.subtitleIndex]);\n\t// }\n\n}\n\nfunction getRandomInt(min, max) {\n  return Math.floor(Math.random() * (max - min)) + min;\n}\n\n\n\n// TODO CORS xhr\nfunction download(mime, url) {\n\t// console.log('inside');\n\tlet xhr = new XMLHttpRequest();\n\n\txhr.open('GET', url, true);\n\txhr.withCredentials = true;\n\txhr.responseTye = 'blob';\n\n\n\txhr.onload = (e) => {\n\t\tif (this.status === 200) {\n\t\t\tlet blob = new Blob(\n\t\t\t\t[this.response],\n\t\t\t\t{\n\t\t\t\t\ttype: mime\n\t\t\t\t}\n\t\t\t);\n\n\t\t\t// console.dir(blob);\n\n\t\t}\n\t};\n\n\txhr.send();\n}\n\n// loadMedia('video/mp4', urls.video);"],"sourceRoot":"/source/"}